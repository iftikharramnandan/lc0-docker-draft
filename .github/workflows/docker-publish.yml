name: Build and Publish Docker Image

on:
  # Client release published (tag like v34)
  release:
    types: [published]

  # Will be used in PR3 (lc0 repo dispatch). Safe to include now.
  repository_dispatch:
    types: [lc0-release]

  # Nightly edge builds from lc0 master (for testing)
  schedule:
    - cron: '0 0 * * *'  # UTC midnight

  # Rebuild :edge when Docker/CI files change on release branch
  push:
    branches: [release]
    paths:
      - Dockerfile
      - .github/workflows/docker-publish.yml

  # Manual trigger for testing / hotfix builds
  workflow_dispatch:
    inputs:
      lc0_version:
        description: "lc0 version tag (e.g., v0.32.1). Leave blank to use Dockerfile default."
        required: false
        default: ""
      client_version:
        description: "Client version tag (e.g., v34). Leave blank to use Dockerfile default."
        required: false
        default: ""
      push:
        description: "Push to GHCR (set false for dry-run testing)"
        type: boolean
        required: false
        default: true
      edge:
        description: "Build as edge (uses lc0 master, tags as :edge only)"
        type: boolean
        required: false
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: leelachesszero/lc0-training-client

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read default versions from Dockerfile
        id: defaults
        run: |
          set -euo pipefail
          DEFAULT_LC0_VERSION="$(grep -E '^ARG LC0_VERSION=' Dockerfile | head -n1 | cut -d= -f2)"
          DEFAULT_CLIENT_VERSION="$(grep -E '^ARG CLIENT_VERSION=' Dockerfile | head -n1 | cut -d= -f2)"
          echo "default_lc0_version=$DEFAULT_LC0_VERSION" >> "$GITHUB_OUTPUT"
          echo "default_client_version=$DEFAULT_CLIENT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Determine versions + push behavior
        id: versions
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          DISPATCH_LC0_VERSION: ${{ github.event.client_payload.lc0_version }}
          DISPATCH_CLIENT_VERSION: ${{ github.event.client_payload.client_version }}
          INPUT_LC0_VERSION: ${{ github.event.inputs.lc0_version }}
          INPUT_CLIENT_VERSION: ${{ github.event.inputs.client_version }}
          INPUT_PUSH: ${{ github.event.inputs.push }}
          INPUT_EDGE: ${{ github.event.inputs.edge }}
          DEFAULT_LC0_VERSION: ${{ steps.defaults.outputs.default_lc0_version }}
          DEFAULT_CLIENT_VERSION: ${{ steps.defaults.outputs.default_client_version }}
        run: |
          set -euo pipefail

          LC0_VERSION="$DEFAULT_LC0_VERSION"
          CLIENT_VERSION="$DEFAULT_CLIENT_VERSION"
          DO_PUSH="true"
          IS_EDGE="false"

          if [ "$EVENT_NAME" = "schedule" ] || [ "$EVENT_NAME" = "push" ]; then
            # Nightly scheduled builds and push-triggered builds are edge builds (lc0 master)
            LC0_VERSION="master"
            IS_EDGE="true"
          elif [ "$EVENT_NAME" = "release" ]; then
            # Release tag is the client version (e.g. v34)
            if [ -n "${RELEASE_TAG:-}" ]; then
              CLIENT_VERSION="$RELEASE_TAG"
            fi
          elif [ "$EVENT_NAME" = "repository_dispatch" ]; then
            # Will be used in PR3 (lc0 release triggers)
            if [ -n "${DISPATCH_LC0_VERSION:-}" ]; then
              LC0_VERSION="$DISPATCH_LC0_VERSION"
            fi
            if [ -n "${DISPATCH_CLIENT_VERSION:-}" ]; then
              CLIENT_VERSION="$DISPATCH_CLIENT_VERSION"
            fi
          elif [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            if [ "${INPUT_EDGE:-false}" = "true" ]; then
              # Manual edge build
              LC0_VERSION="master"
              IS_EDGE="true"
            else
              if [ -n "${INPUT_LC0_VERSION:-}" ]; then
                LC0_VERSION="$INPUT_LC0_VERSION"
              fi
              if [ -n "${INPUT_CLIENT_VERSION:-}" ]; then
                CLIENT_VERSION="$INPUT_CLIENT_VERSION"
              fi
            fi
            if [ "${INPUT_PUSH:-true}" = "false" ]; then
              DO_PUSH="false"
            fi
          fi

          {
            echo "lc0_version=$LC0_VERSION"
            echo "client_version=$CLIENT_VERSION"
            echo "do_push=$DO_PUSH"
            echo "is_edge=$IS_EDGE"
          } >> "$GITHUB_OUTPUT"

      - name: Generate GHCR tags
        id: tags
        env:
          LC0_VERSION: ${{ steps.versions.outputs.lc0_version }}
          CLIENT_VERSION: ${{ steps.versions.outputs.client_version }}
          IS_EDGE: ${{ steps.versions.outputs.is_edge }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          set -euo pipefail
          if [ "$IS_EDGE" = "true" ]; then
            # Edge builds only get :edge tag
            {
              echo "tags<<EOF"
              echo "${REGISTRY}/${IMAGE_NAME}:edge"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            # Stable builds get full tag set
            {
              echo "tags<<EOF"
              echo "${REGISTRY}/${IMAGE_NAME}:latest"
              echo "${REGISTRY}/${IMAGE_NAME}:lc0-${LC0_VERSION}"
              echo "${REGISTRY}/${IMAGE_NAME}:client-${CLIENT_VERSION}"
              echo "${REGISTRY}/${IMAGE_NAME}:lc0-${LC0_VERSION}_client-${CLIENT_VERSION}"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build locally first (no push), run sanity checks, then push.
      - name: Build image (local)
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: lc0-training-client:test
          build-args: |
            LC0_VERSION=${{ steps.versions.outputs.lc0_version }}
            CLIENT_VERSION=${{ steps.versions.outputs.client_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test client --help
        run: docker run --rm lc0-training-client:test --help

      - name: Test engine --help (entrypoint override)
        run: docker run --rm --entrypoint /app/lc0 lc0-training-client:test --help

      - name: Created timestamp
        id: created
        run: echo "created=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        if: steps.versions.outputs.do_push == 'true' && github.repository_owner == 'LeelaChessZero'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (GHCR)
        if: steps.versions.outputs.do_push == 'true' && github.repository_owner == 'LeelaChessZero'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            LC0_VERSION=${{ steps.versions.outputs.lc0_version }}
            CLIENT_VERSION=${{ steps.versions.outputs.client_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.created.outputs.created }}

      - name: Summary
        run: |
          {
            echo "## Docker build summary"
            echo ""
            if [ "${{ steps.versions.outputs.is_edge }}" = "true" ]; then
              echo "**Type:** Edge (lc0 master)"
            else
              echo "**Type:** Stable"
            fi
            echo "**lc0:** ${{ steps.versions.outputs.lc0_version }}"
            echo "**Client:** ${{ steps.versions.outputs.client_version }}"
            echo "**Push:** ${{ steps.versions.outputs.do_push }}"
            echo ""
            echo "### Tags"
            echo '```'
            echo "${{ steps.tags.outputs.tags }}"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      # TODO(pre-merge): Uncomment to enable releases URL in docs/DOCKER.md
      # This uploads auto-update.sh as a release asset so users can download via:
      #   curl -fLO https://github.com/LeelaChessZero/lczero-client/releases/latest/download/auto-update.sh
      # - name: Upload auto-update.sh to release
      #   if: github.event_name == 'release'
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     files: scripts/auto-update.sh
